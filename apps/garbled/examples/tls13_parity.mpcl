// -*- go -*-

package main

import (
	"crypto/aes"
)

// stream mode MPCLDIR=./../../ ./garbled -stream -v -i 0x4647eb76ffd794580046acf096d6b7a2 examples/tls13_parity.mpcl
// MPCLDIR=./../../ ./garbled -v -i 0x4647eb76ffd794580046acf096d6b7a2 examples/tls13_parity.mpcl
type Garbler struct {
	mask [16]byte
}

// todo: update 2kB table!
// 256B MPCLDIR=./../../ ./garbled -e -v -i 0xc0267bad175383cc01933580d818c7459a9e760a77be14f73b03c186e045f1705952f0739c93210b776141d2ed286f288df92c273cc0489f7e1ee92014c9a2ae0c02b063ef95e4277f4ab83e5d778daf73038ff41a0b6701a4eecf6f4596d5e68257bc3baef603d2287373192a2506ddd3c1c87ded3d35763def98c9e385c809d26044eda29369b5de4c5fe89c848b5d44639daa2fe9d680198e2ac79240a6fa1df8437ee4fa2570af3ce42b25cc717f2b18db3aae9197aa20c0c0a0a28e9e94455a588405a3491381b0a67f72c9c3fb40d7bad27d698e1058b814f38c927cbfa0dac036c78c65e728d110027cafac12dd0c69da3732f28a4fd513d6eddb8cb5 examples/tls13_parity.mpcl
// 2kB MPCLDIR=./../../ ./garbled -e -v -i 0xc0267bad175383cc01933580d818c7459a9e760a77be14f73b03c186e045f1705952f0739c93210b776141d2ed286f288df92c273cc0489f7e1ee92014c9a2ae0c02b063ef95e4277f4ab83e5d778daf73038ff41a0b6701a4eecf6f4596d5e68257bc3baef603d2287373192a2506ddd3c1c87ded3d35763def98c9e385c809d26044eda29369b5de4c5fe89c848b5d44639daa2fe9d680198e2ac79240a6fa1df8437ee4fa2570af3ce42b25cc717f2b18db3aae9197aa20c0c0a0a28e9e94455a588405a3491381b0a67f72c9c3fb40d7bad27d698e1058b814f38c927cbfa0dac036c78c65e728d110027cafac12dd0c69da3732f28a4fd513d6eddb8cb51981954ff6fa323653b92f851df8a5e7c378a9ca2dd4f70ba0d658414691fc824902cf6195fc4781f75d254c857513eaae2a6270293caa676931e537046cfb04649d96ae6c469a8263c6f79e87b35506b94c5685da689315efc0ef87ddf4ff6731a610f7c730574e6f133f9171737e6c8f1e0aafc08d8a840064c6709e17970bc44ca1d82870dd2a070d43680054476f7ea28347a2cf71db8812d302e852cf507244ebf14622a6dc4796904e70d72b0f578935212149dae0a6d4075aef948f3a872c60d828f5dc9e9698121abdaf797274dcb69bc7dbe1b683b2ecb5ffdbed8afe48ea2e22f334426642e22ab1e58490d32ce95c25c4181b4449aa9baf83461d123b8120418cfeaac27bd635b3c5b63882856c8699b5881085f72b5da9ebbb21066186c844b4b260b7eb646a3b111644365a5067e796c4d32f492524fbca640887e1fb0d92f2afd826736620e90e02722a2e56fb8f7c41ceb2e3c8203899e8580b7deb3a3944f8ee3f19616a72357e8cd35cc048b64591c287e812b641af11c80cd4363304e24429bf711c2e2080e30c99bb7d1c0b6b96b596550537b05beb63676750ef1c4cb640135f26ba0a5e820def05213a232a7265c08434eb077e3e032f25278a2a68d67d3d33c0a96948dd4655f4abcad754c5d2331098ef29c8a29c6a651db1f33d6603951d8cbd51bf8bdc280ec83974a8071c0975c0a240ef5f74b2953ef3d1009f5b2420c825d1b991bcfc6a40f62f960acef7ae44b4dd9050e6fd65a7f023e7fe7000ce137daed37e8934dc2c65057cdf2a78c0c630549e3f51f7dfa0248e97c68e87d8b12f10e16536fa17bdce86652849c6489b58fa90476ae99e0994e1626b6d424b06c034d3669c18271aab04269d6bd6d156369c1b408db5d8da943b59ac141a57cca889280c1c1a1adcd3dd90fad2d7dc09aaa9705e272552680513d09d1431a2a4ebdd468c6c8ffcb7c6f52a01363ac895ea00fcc0b2cda72bffc97d9567c71cef613685c89a68b0a23e32c9359378869a69d790c90b0e48042e68b85e4f785f902486671ef534fd65d05fe4be68b33d9bcaa05d2cc94d542f45beee899566e602bc1f85ae9033f664e154cf46d53496765c0d6d433fc15a1f6c28f2355f6d265792c28f9973835fba3e5d5b6e5a6c95d7c7dee8d021924e2fccfdca7fa743b5049b1d9d5f7c600106ec976cd9664b1846553803ba9b53316592daf9d917d48a6012b9905d6a4cff351a6906aa3e1450edbc880405dd5e48885c964fd6e7ea2b8332259e0f849eeb0b93b999069472c8284415ae0dbc8b6337e3b54d2ed6843ed0b30c2d07ff2c42af049e3517619deb40f1b5ab8ba45178e1ea9bd1ad8e729c01f39eff87a1d3d598568bf05a796a5c032b39423c09f91dc5c431c3946f17454f8fb188ad75e54726e977bbc56403afc600650c189563a906cfff8969b5b405434c3cbfe467f9bb3bb56ad868918345f999c11b47d07445e28233dc2cc8b1a8c20ded504ac51299a8092ceca8c0929874dc51af95a90b83fe757fc26559b73da9856bd2afcb894e8a06451727b7c5cd056ef75fea4d5f189b6732b96259c48504e9181673811c685595805c2964ba972ca80d8f28c42500e3aff776664d139dacb2c10d4abfca49db098f1917d4d11f9307bafee3bf18393e0836aacc01fac29ca5fddaaf220544062d7e0bc8594a474d5a6ef584abe434a7e747a9a9886cf9d6310d566b3202f9ba9fc2f8cbe7c989df1300fc9486721ba264c399fff918f0e8e7072236dbd498322ec39243d4117db72715eab8b52995966ebbcc766b34f1503b1fd1470422794a9fd2c32417aac589d3d415cc75ab93c91256db34b2f86420c20d9914490548bb75b67eed768fa557e1065cc5e2364917afdc74dce929081c3c1963f6f5cf1e7e1cc0492ed18b33803a14b3f602a3b32e33acfdc95cef375e39fa3934957d2683693ebbda9979f5c6393d17ecbf25971e3efdbbe0322c9c98bf289db76f86ce518c98220547696a41a2cf3be95c339a502b88061ccdf379a672422239ecdff2cea24d12819b18c4cd74b040afba3dc46f94dbe079ed0292eef7f1cba8c31d89071d863468e6a4a8b5457db55e4ad495d53129fa410632ba5733d47f4a11cf19eacbf457453f08b965bb9649ed525d7f1be9b8da9a67032e347e6862d82670b13ab2bcca268dc8f87a04190108c177194b654dc937290307018350e1d95cbac646b33ee60a8d5d86e5b7f557cc41f4511952f83fe4f008edde5ba9912c7a48096a487d266963d3f05c133abef337e4cb146261ec09583f4946b59b4689b4ea13759868ba9b209e3f86dd962fcb0756b58fade74d3a046f0ec037661d60c587778eaae171cb88e296854073bcd7e1744e677a8b201fe688057a26b9a1992bca5c5c92ba7bc70c39cd6ec61fedc5e69927e90b8a3f45273742569024cc5b2e examples/tls13_parity.mpcl
type Evaluator struct {
	ecbVector [2000]byte
}

// 2kB, set 125 ecbs
// 256: checksum: 3e7b7bedc65982f40ba38c7960828723, mask: 4647eb76ffd794580046acf096d6b7a2
// 256B: c0267bad175383cc01933580d818c7459a9e760a77be14f73b03c186e045f1705952f0739c93210b776141d2ed286f288df92c273cc0489f7e1ee92014c9a2ae0c02b063ef95e4277f4ab83e5d778daf73038ff41a0b6701a4eecf6f4596d5e68257bc3baef603d2287373192a2506ddd3c1c87ded3d35763def98c9e385c809d26044eda29369b5de4c5fe89c848b5d44639daa2fe9d680198e2ac79240a6fa1df8437ee4fa2570af3ce42b25cc717f2b18db3aae9197aa20c0c0a0a28e9e94455a588405a3491381b0a67f72c9c3fb40d7bad27d698e1058b814f38c927cbfa0dac036c78c65e728d110027cafac12dd0c69da3732f28a4fd513d6eddb8cb5

// return: protected ecbk,ecb1, and ecbs with counter>1 in one slice
func main(g Garbler, e Evaluator) []byte {

	// init checksum
	numberECBs := 125 * 16
	var parityChecksum [aes.BlockSize]byte

	// var block [aes.BlockSize]byte

	for i := 0; i < numberECBs; i += aes.BlockSize {
		for j := 0; i+j < numberECBs && j < aes.BlockSize; j++ {
			parityChecksum[j] = e.ecbVector[i+j] ^ parityChecksum[j]
		}
	}

	// compute mask on top
	for i := 0; i < 16; i++ {
		parityChecksum[i] = parityChecksum[i] ^ g.mask[i]
	}

	return parityChecksum[:]
}

// out: c5685aad8db5a694505599388d7fb8d8

// Result[0]: ecb0: 0x895b8c63da8da17e9d6d30c62f09d6f5
// Result[1]: ecb1: 0x9b89f7120fe41972a4e81f2e63453807
// Result[2]: 2kB ecbVector: c0267bad175383cc01933580d818c7459a9e760a77be14f73b03c186e045f1705952f0739c93210b776141d2ed286f288df92c273cc0489f7e1ee92014c9a2ae0c02b063ef95e4277f4ab83e5d778daf73038ff41a0b6701a4eecf6f4596d5e68257bc3baef603d2287373192a2506ddd3c1c87ded3d35763def98c9e385c809d26044eda29369b5de4c5fe89c848b5d44639daa2fe9d680198e2ac79240a6fa1df8437ee4fa2570af3ce42b25cc717f2b18db3aae9197aa20c0c0a0a28e9e94455a588405a3491381b0a67f72c9c3fb40d7bad27d698e1058b814f38c927cbfa0dac036c78c65e728d110027cafac12dd0c69da3732f28a4fd513d6eddb8cb51981954ff6fa323653b92f851df8a5e7c378a9ca2dd4f70ba0d658414691fc824902cf6195fc4781f75d254c857513eaae2a6270293caa676931e537046cfb04649d96ae6c469a8263c6f79e87b35506b94c5685da689315efc0ef87ddf4ff6731a610f7c730574e6f133f9171737e6c8f1e0aafc08d8a840064c6709e17970bc44ca1d82870dd2a070d43680054476f7ea28347a2cf71db8812d302e852cf507244ebf14622a6dc4796904e70d72b0f578935212149dae0a6d4075aef948f3a872c60d828f5dc9e9698121abdaf797274dcb69bc7dbe1b683b2ecb5ffdbed8afe48ea2e22f334426642e22ab1e58490d32ce95c25c4181b4449aa9baf83461d123b8120418cfeaac27bd635b3c5b63882856c8699b5881085f72b5da9ebbb21066186c844b4b260b7eb646a3b111644365a5067e796c4d32f492524fbca640887e1fb0d92f2afd826736620e90e02722a2e56fb8f7c41ceb2e3c8203899e8580b7deb3a3944f8ee3f19616a72357e8cd35cc048b64591c287e812b641af11c80cd4363304e24429bf711c2e2080e30c99bb7d1c0b6b96b596550537b05beb63676750ef1c4cb640135f26ba0a5e820def05213a232a7265c08434eb077e3e032f25278a2a68d67d3d33c0a96948dd4655f4abcad754c5d2331098ef29c8a29c6a651db1f33d6603951d8cbd51bf8bdc280ec83974a8071c0975c0a240ef5f74b2953ef3d1009f5b2420c825d1b991bcfc6a40f62f960acef7ae44b4dd9050e6fd65a7f023e7fe7000ce137daed37e8934dc2c65057cdf2a78c0c630549e3f51f7dfa0248e97c68e87d8b12f10e16536fa17bdce86652849c6489b58fa90476ae99e0994e1626b6d424b06c034d3669c18271aab04269d6bd6d156369c1b408db5d8da943b59ac141a57cca889280c1c1a1adcd3dd90fad2d7dc09aaa9705e272552680513d09d1431a2a4ebdd468c6c8ffcb7c6f52a01363ac895ea00fcc0b2cda72bffc97d9567c71cef613685c89a68b0a23e32c9359378869a69d790c90b0e48042e68b85e4f785f902486671ef534fd65d05fe4be68b33d9bcaa05d2cc94d542f45beee899566e602bc1f85ae9033f664e154cf46d53496765c0d6d433fc15a1f6c28f2355f6d265792c28f9973835fba3e5d5b6e5a6c95d7c7dee8d021924e2fccfdca7fa743b5049b1d9d5f7c600106ec976cd9664b1846553803ba9b53316592daf9d917d48a6012b9905d6a4cff351a6906aa3e1450edbc880405dd5e48885c964fd6e7ea2b8332259e0f849eeb0b93b999069472c8284415ae0dbc8b6337e3b54d2ed6843ed0b30c2d07ff2c42af049e3517619deb40f1b5ab8ba45178e1ea9bd1ad8e729c01f39eff87a1d3d598568bf05a796a5c032b39423c09f91dc5c431c3946f17454f8fb188ad75e54726e977bbc56403afc600650c189563a906cfff8969b5b405434c3cbfe467f9bb3bb56ad868918345f999c11b47d07445e28233dc2cc8b1a8c20ded504ac51299a8092ceca8c0929874dc51af95a90b83fe757fc26559b73da9856bd2afcb894e8a06451727b7c5cd056ef75fea4d5f189b6732b96259c48504e9181673811c685595805c2964ba972ca80d8f28c42500e3aff776664d139dacb2c10d4abfca49db098f1917d4d11f9307bafee3bf18393e0836aacc01fac29ca5fddaaf220544062d7e0bc8594a474d5a6ef584abe434a7e747a9a9886cf9d6310d566b3202f9ba9fc2f8cbe7c989df1300fc9486721ba264c399fff918f0e8e7072236dbd498322ec39243d4117db72715eab8b52995966ebbcc766b34f1503b1fd1470422794a9fd2c32417aac589d3d415cc75ab93c91256db34b2f86420c20d9914490548bb75b67eed768fa557e1065cc5e2364917afdc74dce929081c3c1963f6f5cf1e7e1cc0492ed18b33803a14b3f602a3b32e33acfdc95cef375e39fa3934957d2683693ebbda9979f5c6393d17ecbf25971e3efdbbe0322c9c98bf289db76f86ce518c98220547696a41a2cf3be95c339a502b88061ccdf379a672422239ecdff2cea24d12819b18c4cd74b040afba3dc46f94dbe079ed0292eef7f1cba8c31d89071d863468e6a4a8b5457db55e4ad495d53129fa410632ba5733d47f4a11cf19eacbf457453f08b965bb9649ed525d7f1be9b8da9a67032e347e6862d82670b13ab2bcca268dc8f87a04190108c177194b654dc937290307018350e1d95cbac646b33ee60a8d5d86e5b7f557cc41f4511952f83fe4f008edde5ba9912c7a48096a487d266963d3f05c133abef337e4cb146261ec09583f4946b59b4689b4ea13759868ba9b209e3f86dd962fcb0756b58fade74d3a046f0ec037661d60c587778eaae171cb88e296854073bcd7e1744e677a8b201fe688057a26b9a1992bca5c5c92ba7bc70c39cd6ec61fedc5e69927e90b8a3f45273742569024cc5b2e
